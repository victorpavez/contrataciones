<!-- CAMBIO AUTORIZADO: Se agregan campos de texto si 'tipo' o 'categoría' es 'otros' -->
<!DOCTYPE html>
<html lang="es">
<head>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Formulario Secretaría de Obras</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body {
      background: linear-gradient(to right, #eef2f3, #8e9eab);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .container {
      background-color: #ffffff;
      border-radius: 16px;
      padding: 3rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      max-width: 850px;
    }
    h2 {
      font-weight: 700;
      color: #343a40;
      border-bottom: 2px solid #007bff;
      padding-bottom: 0.5rem;
      margin-bottom: 2rem;
    }
    .form-label {
      font-weight: 600;
      color: #333;
    }
    .form-control,
    .form-select {
      border-radius: 8px;
      border-color: #ced4da;
    }
    .form-control:focus,
    .form-select:focus {
      box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
      border-color: #007bff;
    }
    .btn-primary {
      background: linear-gradient(135deg, #007bff, #0056b3);
      border: none;
      border-radius: 8px;
      font-weight: 600;
      padding: 0.6rem 1.5rem;
      transition: all 0.3s ease;
    }
    .btn-primary:hover {
      background: linear-gradient(135deg, #0056b3, #003f7f);
      transform: scale(1.03);
    }
    .alert {
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <div class="container py-5">
    <h2>Formulario - Secretaría de Obras</h2>
    <div class="mb-4">
      <label class="form-label">Información del Solicitante</label>
      <div class="alert alert-secondary">
        <strong>Nombre:</strong> <span id="info-nombre"></span><br>
        <strong>Secretaría:</strong> <span id="info-secretaria"></span>
      </div>
    </div>
    <form id="formulario-obras">
      <div class="mb-3">
        <label for="area" class="form-label">Área:</label>
        <select id="area" name="area" class="form-select" required></select>
      </div>
      <div class="mb-3">
        <label for="rubro" class="form-label">Rubro:</label>
        <select id="rubro" name="rubro" class="form-select" required></select>
      </div>
      <div class="mb-3">
        <label for="tipo" class="form-label">Tipo:</label>
        <select id="tipo" name="tipo" class="form-select" required></select>
      </div>
      <div class="mb-3 d-none" id="detalle-tipo-container">
        <label for="detalle-tipo" class="form-label">Detalle de Tipo:</label>
        <input type="text" id="detalle-tipo" name="detalle-tipo" class="form-control" placeholder="Especifique otro tipo">
      </div>
      <div class="mb-3 row d-none" id="detalle-reparacion-container">
        <label for="detalle-reparacion" class="col-sm-3 col-form-label">Detalle de Reparación:</label>
        <div class="col-sm-9">
          <textarea id="detalle-reparacion" name="detalle-reparacion" class="form-control" rows="3"></textarea>
        </div>
      </div>
      <div class="mb-3 row d-none" id="cronograma-container">
  <label class="col-sm-3 col-form-label">Cronograma:</label>
  <div class="col-sm-9">
    <div class="d-flex flex-column gap-2">
      <div class="d-flex align-items-center gap-2">
        <input class="form-check-input dia-checkbox" type="checkbox" id="lunes">
        <label class="form-check-label me-2" for="lunes">Lunes</label>
        <input type="number" min="0" max="24" class="form-control form-control-sm hora-dia" data-dia="lunes" placeholder="hrs" style="width: 80px;" disabled>
      </div>
      <div class="d-flex align-items-center gap-2">
        <input class="form-check-input dia-checkbox" type="checkbox" id="martes">
        <label class="form-check-label me-2" for="martes">Martes</label>
        <input type="number" min="0" max="24" class="form-control form-control-sm hora-dia" data-dia="martes" placeholder="hrs" style="width: 80px;" disabled>
      </div>
      <div class="d-flex align-items-center gap-2">
        <input class="form-check-input dia-checkbox" type="checkbox" id="miercoles">
        <label class="form-check-label me-2" for="miercoles">Miércoles</label>
        <input type="number" min="0" max="24" class="form-control form-control-sm hora-dia" data-dia="miercoles" placeholder="hrs" style="width: 80px;" disabled>
      </div>
      <div class="d-flex align-items-center gap-2">
        <input class="form-check-input dia-checkbox" type="checkbox" id="jueves">
        <label class="form-check-label me-2" for="jueves">Jueves</label>
        <input type="number" min="0" max="24" class="form-control form-control-sm hora-dia" data-dia="jueves" placeholder="hrs" style="width: 80px;" disabled>
      </div>
      <div class="d-flex align-items-center gap-2">
        <input class="form-check-input dia-checkbox" type="checkbox" id="viernes">
        <label class="form-check-label me-2" for="viernes">Viernes</label>
        <input type="number" min="0" max="24" class="form-control form-control-sm hora-dia" data-dia="viernes" placeholder="hrs" style="width: 80px;" disabled>
      </div>
      <div class="d-flex align-items-center gap-2">
        <input class="form-check-input dia-checkbox" type="checkbox" id="sabado">
        <label class="form-check-label me-2" for="sabado">Sábado</label>
        <input type="number" min="0" max="24" class="form-control form-control-sm hora-dia" data-dia="sabado" placeholder="hrs" style="width: 80px;" disabled>
      </div>
      <div class="d-flex align-items-center gap-2">
        <input class="form-check-input dia-checkbox" type="checkbox" id="domingo">
        <label class="form-check-label me-2" for="domingo">Domingo</label>
        <input type="number" min="0" max="24" class="form-control form-control-sm hora-dia" data-dia="domingo" placeholder="hrs" style="width: 80px;" disabled>
      </div>
    </div>
  </div>
</div>
      <div class="mb-3">
        <label for="categoria" class="form-label">Categoría:</label>
        <select id="categoria" name="categoria" class="form-select" required></select>
      </div>
      <div class="mb-3 d-none" id="detalle-categoria-container">
        <label for="detalle-categoria" class="form-label">Detalle de Categoría:</label>
        <input type="text" id="detalle-categoria" name="detalle-categoria" class="form-control" placeholder="Especifique otra categoría">
      </div>
      <div class="mb-3 row">
        <div class="col-md-6">
          <label for="fecha" class="form-label">Fecha de Pedido:</label>
          <input type="date" id="fecha" name="fecha" class="form-control" required>
        </div>
        <div class="col-md-6">
          <label for="periodo" class="form-label">Período de Ejecución / Entrega:</label>
          <input type="text" id="periodo" name="periodo" class="form-control" placeholder="Seleccione un rango de fechas" required readonly>
        </div>
      </div>
      <div class="mb-3">
        <label for="presupuesto" class="form-label">Presupuesto Estimado:</label>
        <input type="number" id="presupuesto" name="presupuesto" class="form-control" min="0" step="0.01" required>
      </div>
      <button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane me-2"></i>Enviar</button>
    </form>
  </div>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.dia-checkbox').forEach(checkbox => {
      checkbox.addEventListener('change', () => {
        const input = checkbox.parentElement.querySelector('.hora-dia');
        if (input) {
          input.disabled = !checkbox.checked;
          if (!checkbox.checked) input.value = '';
        }
      });
    });

    const params = new URLSearchParams(window.location.search);
    document.getElementById('info-nombre').textContent = params.get('nombre') || '—';
    document.getElementById('info-secretaria').textContent = params.get('secretaria') || '—';

    const areaSelect = document.getElementById('area');
    const rubroSelect = document.getElementById('rubro');
    const tipoSelect = document.getElementById('tipo');
    const categoriaSelect = document.getElementById('categoria');
    const detalleTipo = document.getElementById('detalle-tipo-container');
    const detalleCategoria = document.getElementById('detalle-categoria-container');

    const datos = {
      areas: ['Coordinador General', 'Vialidad', 'Alumbrado Público', 'Monitoreo y Arreglos Eléctricos'],
      rubros: {
        maquinaria: {
          tipos: {
            reparacion: ['UNIDAD 1', 'UNIDAD 2'],
            alquiler: ['CAMIONETA', 'CAMION'],
            compra: ['RETROEXCAVADORA', 'HIDROGRUA']
          }
        },
        servicio: {
          tipos: {
            profesionales: ['AGRIMENSOR', 'TECNICO']
          }
        },
        adquisicion: {
          tipos: {
            caños: ['PVC', 'Hierro'],
            otros: ['Variado']
          }
        }
      }
    };

    datos.areas.forEach(area => {
      const opt = document.createElement('option');
      opt.value = area;
      opt.textContent = area;
      areaSelect.appendChild(opt);
    });

    Object.keys(datos.rubros).forEach(rubro => {
      const opt = document.createElement('option');
      opt.value = rubro;
      opt.textContent = rubro;
      rubroSelect.appendChild(opt);
    });

    rubroSelect.addEventListener('change', () => {
      const rubro = rubroSelect.value;
      tipoSelect.innerHTML = '<option value="">Seleccione un tipo</option>';
      categoriaSelect.innerHTML = '<option value="">Seleccione una categoría</option>';

      if (datos.rubros[rubro]) {
        Object.keys(datos.rubros[rubro].tipos).forEach(tipo => {
          const opt = document.createElement('option');
          opt.value = tipo;
          opt.textContent = tipo;
          tipoSelect.appendChild(opt);
        });
        tipoSelect.appendChild(new Option('otros', 'otros'));
      }
    });

    tipoSelect.addEventListener('change', () => {
      const detalleReparacionContainer = document.getElementById('detalle-reparacion-container');
      const cronogramaContainer = document.getElementById('cronograma-container');
      const rubro = rubroSelect.value;
      const tipo = tipoSelect.value;
      categoriaSelect.innerHTML = '<option value="">Seleccione una categoría</option>';

      if (datos.rubros[rubro] && datos.rubros[rubro].tipos[tipo]) {
        datos.rubros[rubro].tipos[tipo].forEach(cat => {
          const opt = document.createElement('option');
          opt.value = cat;
          opt.textContent = cat;
          categoriaSelect.appendChild(opt);
        });
      }
      categoriaSelect.appendChild(new Option('otros', 'otros'));
      detalleTipo.classList.toggle('d-none', tipoSelect.value !== 'otros');
      cronogramaContainer.classList.toggle('d-none', !(tipo === 'profesionales' || tipo === 'alquiler'));
      detalleReparacionContainer.classList.toggle('d-none', tipo !== 'reparacion');
    });

    categoriaSelect.addEventListener('change', () => {
      detalleCategoria.classList.toggle('d-none', categoriaSelect.value !== 'otros');
    });
  });
</script>
<script>
  flatpickr("#periodo", {
    mode: "range",
    dateFormat: "d/m/Y",
    locale: "es"
  });
</script>
<script>
  document.getElementById('formulario-obras').addEventListener('submit', function(event) {
    event.preventDefault();
    const formData = new FormData(this);
    const data = {};
    formData.forEach((value, key) => {
      data[key] = value;
    });

    document.querySelectorAll('.hora-dia').forEach(input => {
      if (!input.disabled && input.value) {
        data['cronograma_' + input.dataset.dia] = input.value;
      }
    });

    const nombre = document.getElementById('info-nombre').textContent;
    const secretaria = document.getElementById('info-secretaria').textContent;
    data['nombre'] = nombre;
    data['secretaria'] = secretaria;

    // Validación externa
    if (typeof validarFormularioObras === 'function') {
      const esValido = validarFormularioObras(data);
      if (!esValido) return;
    }

    localStorage.setItem('datosFormularioObras', JSON.stringify(data));
    window.location.href = 'datos_recibidos.html';
  });
</script>
  <script src="validarFormulario.js"></script>
</body>
</html>
